## server.js 功能轉型 EJS 及功能優化報告

日期：2025-05-12

### 專案目標

本次任務的主要目標是將原有 `server.js` 檔案中直接生成 HTML 的邏輯，轉換為使用 EJS (Embedded JavaScript) 模板引擎進行處理。同時，根據使用者需求，實現檢驗結果頁面中各項檢驗結果的分類展示，並提供可收摺/展開的互動功能，且預設將所有分類設定為展開狀態。

### 主要變更與實施細節

1.  **`server.js` 重構**：對 `server.js` 進行了顯著重構，移除了所有直接拼接 HTML 字串的程式碼。取而代之的是，在各個路由處理函式中，通過 `res.render()` 方法來渲染對應的 EJS 模板，並將必要的資料傳遞給模板。

2.  **EJS 模板建立**：
    *   `views/index.ejs`：用於展示病患總覽列表。
    *   `views/search.ejs`：用於顯示搜尋病患後的結果列表。
    *   `views/person.ejs`：用於展示單個病患的詳細檢驗報告，包含分類及收摺功能。
    *   `views/error.ejs`：用於顯示錯誤訊息頁面。

3.  **檢驗結果分類與收摺功能**：在 `views/person.ejs` 模板中，重點實現了檢驗結果的分類展示。根據使用者指定的「血脂肪檢查」、「糖尿病檢查」、「腎功能」、「肝功能」、「血液檢查」、「尿液檢查」、「糞便檢查」以及「其他檢查」等大類，對檢驗項目進行了歸類。每個分類都設計為可點擊的標題，使用者可以點擊以收摺或展開該分類下的具體檢驗項目。根據最新需求，所有分類在頁面載入時預設為展開狀態，方便使用者第一時間查看所有內容。

4.  **輔助工具函式**：為了更清晰地處理和組織檢驗項目數據，建立了一個新的 JavaScript 檔案 `utils/categorizeItems.js`。此檔案包含將原始檢驗數據根據預設分類邏輯進行分組的函式，供 `server.js` 在準備傳遞給 `person.ejs` 模板的資料時調用。

### 問題修復

在開發與測試過程中，遇到了並解決了以下主要問題：

1.  **資料庫連接問題**：初期嘗試連接 MongoDB Atlas 資料庫時，遇到了 `MongoNetworkError: tlsv1 alert internal error` 的錯誤。此問題已得到解決，確保應用程式能夠穩定連接資料庫並讀取所需數據。

2.  **搜尋功能正則表達式錯誤**：發現當使用者在搜尋框中輸入包含正則表達式特殊字元（例如問號 `?`）的關鍵字時，會導致伺服器端在構建正則表達式時發生語法錯誤 (`SyntaxError: Invalid regular expression: /?.../: Nothing to repeat`)。已透過對使用者輸入的搜尋關鍵字進行特殊字元跳脫處理，修復了此錯誤，確保搜尋功能在各種輸入情況下的穩定性。

### 驗證結果

經過詳細測試，確認以下功能均已按預期實現：

*   所有主要頁面（首頁、搜尋結果頁、個人詳細報告頁）均能正常載入並顯示正確的資料。
*   個人詳細報告頁面中的檢驗結果已按照指定的大類正確分類。
*   所有分類在頁面初次載入時均預設為展開狀態。
*   使用者可以透過點擊分類標題來收摺或展開各個檢驗項目類別，互動功能運作流暢。
*   搜尋功能在輸入一般關鍵字及包含特殊字元（如 `?`）的關鍵字時，均能返回正確的搜尋結果，不再引發伺服器錯誤。

### 遵循規範

*   **程式碼風格**：開發過程中，已盡力遵循儲存庫中 `開發指南/通用元則.md` 文件所規定的程式碼風格要求。
*   **Git 提交規範**：本次變更的 Git 提交訊息已按照 Conventional Commits 規範編寫。

### 結論

本次 `server.js` 功能向 EJS 模板的轉型任務已成功完成，包括檢驗結果的分類顯示、可收摺/預設展開互動功能的實現，以及過程中發現的若干錯誤修復。應用程式目前功能完整，符合使用者提出的需求。
