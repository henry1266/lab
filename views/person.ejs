<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>病患報告 - <%= patient.patnm || '無名' %> (<%= patient.idno %>)</title>
    <style>
        body { font-family: sans-serif; margin: 10px; background-color: #f4f4f4; color: #333; }
        .container { max-width: 90%; margin: auto; background-color: #fff; padding: 15px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        h2, h3 { color: #333; margin-top: 10px; margin-bottom: 10px; }
        .controls { margin-bottom: 15px; padding: 8px; background-color: #e9ecef; border-radius: 4px; display: flex; flex-wrap: wrap; gap: 10px; align-items: center; }
        .controls label { margin-right: 8px; font-size: 0.85em; cursor: pointer; }
        .controls input[type="checkbox"] { margin-right: 4px; vertical-align: middle; }
        .controls button { padding: 6px 10px; background-color: #007bff; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 0.85em; }
        .controls button:hover { background-color: #0056b3; }
        .date-filters { display: flex; flex-wrap: wrap; gap: 8px; align-items: center;}
        .category-title {
            background-color: #007bff;
            color: white;
            padding: 8px 12px;
            margin-bottom: 0px;
            border-radius: 4px 4px 0 0;
            cursor: pointer;
            font-weight: bold;
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 15px;
        }
        .category-title:hover { background-color: #0056b3; }
        .category-content {
            display: block; /* Categories are expanded by default */
            border: 1px solid #007bff;
            border-top: none;
            padding: 10px;
            border-radius: 0 0 4px 4px;
            margin-bottom: 15px;
            overflow-x: auto; /* For wider tables */
        }
        .toggle-icon { font-size: 1.1em; }
        .back-link { display: inline-block; margin-top: 15px; font-size: 0.9em; }
        table.comparison-table {
            border-collapse: collapse;
            width: auto; 
            table-layout: auto; 
            margin-top: 8px;
            box-shadow: 0 1px 2px rgba(0,0,0,0.1);
        }
        table.comparison-table th, table.comparison-table td {
            border: 1px solid #ddd;
            text-align: left;
            padding: 6px 8px; 
            vertical-align: middle;
            font-size: 0.9em; 
            white-space: nowrap; 
        }
        table.comparison-table th {
            background-color: #6c757d; 
            color: white;
            font-weight: bold;
        }
        table.comparison-table td.col-item-name, table.comparison-table th.col-item-name {
            white-space: normal; 
        }
        table.comparison-table tr:nth-child(even) { background-color: #f9f9f9; }
        table.comparison-table strong { font-weight: bold; }
        .no-data { color: #999; font-style: italic; text-align: center; padding: 10px;}
        .col-hidden { display: none !important; }
        .row-hidden { display: none !important; }
        .col-normal-range {
            background-color: rgb(224, 224, 224);
            color: rgb(0, 0, 0);
        }
        .col-unit {
            background-color: rgb(240, 240, 240);
            color: rgb(0, 0, 0);
        }
        .trend-arrow { margin-left: 4px; font-weight: bold; }
        .trend-up { color: green; }
        .trend-down { color: red; }
        .trend-stable { color: orange; }
    </style>
</head>
<body>
    <div class="container">
        <% if (patient && records && records.length > 0) { %>
            <h2><%= patient.patnm || '無名' %> (<%= patient.idno %>)</h2>
            <p style="font-size: 0.9em; margin-bottom: 5px;">生日：<%= patient.birdt %></p>
            <h3>共 <%= records.length %> 筆報告 - 橫向對比</h3>

            <% 
            const orderedCategories = [
                "血脂肪檢查", "糖尿病檢查", "腎功能", "肝功能", 
                "血液檢查", "尿液檢查", "糞便檢查", "其他檢查"
            ];
            const allReportDates = [...new Set(records.map(r => r.rptdt))].sort((a, b) => new Date(a.split('/').join('-')) - new Date(b.split('/').join('-')));
            %>

            <div class="controls">
                <button id="toggleNormalRangeBtn">切換正常範圍顯示</button>
                <label style="margin-left: 20px;"><input type="checkbox" id="filterAbnormalItemsCb"> 只顯示異常項目</label>
                <div class="date-filters" style="margin-left: 10px;">
                    <span style="font-size: 0.85em;">顯示日期：</span>
                    <% allReportDates.forEach((date, index) => { %>
                        <label>
                            <input type="checkbox" class="date-toggle-cb" data-date-col="date-col-<%= index %>" checked>
                            <%= date %>
                        </label>
                    <% }); %>
                </div>
            </div>

            <% orderedCategories.forEach(categoryName => {
                const uniqueItemsInCategory = new Set();
                const itemDetailsMap = new Map();

                records.forEach(r => {
                    if (r.categorizedItems && r.categorizedItems[categoryName]) {
                        r.categorizedItems[categoryName].forEach(item => {
                            uniqueItemsInCategory.add(item.itmnm);
                            if (!itemDetailsMap.has(item.itmnm)) {
                                let rangeStr = item.refrg || "-";
                                if (rangeStr === "-" && (item.nlow || item.nhigh)) {
                                    if (item.nlow && item.nhigh) rangeStr = `${item.nlow} ~ ${item.nhigh}`;
                                    else if (item.nlow) rangeStr = `≥ ${item.nlow}`;
                                    else if (item.nhigh) rangeStr = `≤ ${item.nhigh}`;
                                }
                                itemDetailsMap.set(item.itmnm, { 
                                    unit: item.rstunit || "",
                                    range: rangeStr,
                                    nlow: item.nlow,
                                    nhigh: item.nhigh
                                });
                            }
                        });
                    }
                });

                if (uniqueItemsInCategory.size > 0) { %>
                    <div class="category-section">
                        <div class="category-title" onclick="toggleCategoryDisplay(this)">
                            <span><%= categoryName %></span>
                            <span class="toggle-icon category-toggle-icon">-</span>
                        </div>
                        <div class="category-content open">
                            <table class="comparison-table">
                                <thead>
                                    <tr>
                                        <th class="col-item-name">檢查項目</th>
                                        <% allReportDates.forEach((date, index) => { %>
                                            <th class="date-col-<%= index %>"><%= date %></th>
                                        <% }); %>
                                        <th class="col-normal-range">正常範圍</th>
                                        <th class="col-unit">單位</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <% Array.from(uniqueItemsInCategory).sort().forEach(itemName => { %>
                                        <% const details = itemDetailsMap.get(itemName); %>
                                        <% let previousNumericResult = null; %>
                                        <% let numericResultsCount = 0; %>
                                        <% 
                                          allReportDates.forEach(reportDate => {
                                            const reportForDate = records.find(r => r.rptdt === reportDate);
                                            if (reportForDate && reportForDate.categorizedItems && reportForDate.categorizedItems[categoryName]) {
                                                const itemInReport = reportForDate.categorizedItems[categoryName].find(i => i.itmnm === itemName);
                                                if (itemInReport && !isNaN(parseFloat(itemInReport.result))) {
                                                    numericResultsCount++;
                                                }
                                            }
                                          });
                                        %>
                                        <tr data-item-name="<%= itemName %>">
                                            <td class="col-item-name"><%= itemName || '無項目' %></td>
                                            <% allReportDates.forEach((reportDate, index) => { %>
                                                <% 
                                                    let cellContent = "—";
                                                    let statusSymbol = "";
                                                    let resultDisplay = "—";
                                                    let trendSymbol = "";
                                                    const reportForDate = records.find(r => r.rptdt === reportDate);
                                                    let itemInReport = null;
                                                    if (reportForDate && reportForDate.categorizedItems && reportForDate.categorizedItems[categoryName]) {
                                                        itemInReport = reportForDate.categorizedItems[categoryName].find(i => i.itmnm === itemName);
                                                    }

                                                    if (itemInReport) {
                                                        resultDisplay = itemInReport.result || "—";
                                                        const currentNumericResult = parseFloat(itemInReport.result);
                                                        const nlowNum = parseFloat(itemInReport.nlow);
                                                        const nhighNum = parseFloat(itemInReport.nhigh);

                                                        if (itemName === "HDL Cholesterol") {
                                                            if (!isNaN(currentNumericResult)) {
                                                                if (currentNumericResult >= 40) statusSymbol = (currentNumericResult >= 42.5) ? "🟢" : "🟡";
                                                                else statusSymbol = "🔴";
                                                                if (currentNumericResult === 45 || currentNumericResult === 42) resultDisplay = `<strong>${itemInReport.result}</strong>`; 
                                                            }
                                                        } else if (itemName === "Triglyceride") {
                                                            if (!isNaN(currentNumericResult)) {
                                                                if (currentNumericResult >= 30 && currentNumericResult <= 150) statusSymbol = "🟢";
                                                                else statusSymbol = "🔴";
                                                                if (currentNumericResult === 136 || currentNumericResult === 138) resultDisplay = `<strong>${itemInReport.result}</strong>`;
                                                            }
                                                        } else if (itemName === "LDL Cholesterol") {
                                                            if (!isNaN(currentNumericResult)) {
                                                                if (currentNumericResult >= 20 && currentNumericResult <= 130) statusSymbol = "🟢";
                                                                else statusSymbol = "🔴";
                                                                if (currentNumericResult === 64 || currentNumericResult === 67) resultDisplay = `<strong>${itemInReport.result}</strong>`;
                                                            }
                                                        } else if (itemName === "HbA1c") {
                                                            if (itemInReport.result) {
                                                                const hba1cVal = parseFloat(itemInReport.result.replace("%",""));
                                                                if (!isNaN(hba1cVal)){
                                                                    if (hba1cVal >= 4.0 && hba1cVal <= 5.6) statusSymbol = "🟢";
                                                                    else statusSymbol = "🔴";
                                                                    if (itemInReport.result === "6.6%" || itemInReport.result === "6.9%") resultDisplay = `<strong>${itemInReport.result}</strong>`;
                                                                }
                                                            }
                                                        } else { 
                                                            if (!isNaN(currentNumericResult) && !isNaN(nlowNum) && !isNaN(nhighNum)) {
                                                                if (currentNumericResult < nlowNum) statusSymbol = "🔴";
                                                                else if (currentNumericResult > nhighNum) statusSymbol = "🔴";
                                                                else statusSymbol = "🟢";
                                                            }
                                                        }

                                                        if (numericResultsCount >= 2 && !isNaN(currentNumericResult)) {
                                                            if (previousNumericResult !== null && !isNaN(previousNumericResult)) {
                                                                if (currentNumericResult > previousNumericResult) trendSymbol = '<span class="trend-arrow trend-up">↑</span>';
                                                                else if (currentNumericResult < previousNumericResult) trendSymbol = '<span class="trend-arrow trend-down">↓</span>';
                                                                else trendSymbol = '<span class="trend-arrow trend-stable">→</span>';
                                                            }
                                                            previousNumericResult = currentNumericResult;
                                                        } else if (!isNaN(currentNumericResult)) {
                                                            previousNumericResult = currentNumericResult; // Store first numeric value
                                                        }

                                                        cellContent = `${resultDisplay} ${statusSymbol} ${trendSymbol}`.trim();
                                                    } else {
                                                        cellContent = "—";
                                                        previousNumericResult = null; // Reset if data is missing for this date
                                                    }
                                                %>
                                                <td class="date-col-<%= index %>" data-status="<%= statusSymbol %>"><%- cellContent %></td>
                                            <% }); %>
                                            <td class="col-normal-range"><%= details.range %></td>
                                            <td class="col-unit"><%= details.unit %></td>
                                        </tr>
                                    <% }); %>
                                </tbody>
                            </table>
                        </div>
                    </div>
                <% } %>
            <% }); %>
        <% } else if (patient) { %>
             <h2><%= patient.patnm || '無名' %> (<%= patient.idno %>)</h2>
             <p style="font-size: 0.9em; margin-bottom: 5px;">生日：<%= patient.birdt %></p>
             <p class="no-data">此病患尚無報告可供對比。</p>
        <% } else { %>
            <p class="no-data">找不到病患資料。</p>
        <% } %>
        <a href="/" class="back-link">← 回首頁</a>
    </div>

    <script>
        function toggleCategoryDisplay(element) {
            const content = element.nextElementSibling;
            const icon = element.querySelector(".category-toggle-icon");
            if (content.style.display === "none" || !content.classList.contains("open")) {
                content.style.display = "block";
                content.classList.add("open");
                icon.textContent = "-";
            } else {
                content.style.display = "none";
                content.classList.remove("open");
                icon.textContent = "+";
            }
        }

        document.addEventListener("DOMContentLoaded", () => {
            const toggleNormalRangeBtn = document.getElementById("toggleNormalRangeBtn");
            const dateToggleCheckboxes = document.querySelectorAll(".date-toggle-cb");
            const filterAbnormalItemsCb = document.getElementById("filterAbnormalItemsCb");

            function applyFilters() {
                const filterAbnormal = filterAbnormalItemsCb.checked;
                
                document.querySelectorAll(".comparison-table tbody tr").forEach(row => {
                    let showRow = true;

                    if (filterAbnormal) {
                        let isRowAbnormal = false;
                        const dataCells = row.querySelectorAll("td[data-status]");
                        for (const cell of dataCells) {
                            const status = cell.dataset.status;
                            if (status === '🔴' || status === '🟡') {
                                isRowAbnormal = true;
                                break;
                            }
                        }
                        if (!isRowAbnormal) {
                            showRow = false;
                        }
                    }
                    
                    if (showRow) {
                        row.classList.remove("row-hidden");
                    } else {
                        row.classList.add("row-hidden");
                    }
                });
            }

            if (toggleNormalRangeBtn) {
                toggleNormalRangeBtn.addEventListener("click", () => {
                    document.querySelectorAll(".comparison-table .col-normal-range, .comparison-table .col-unit").forEach(cell => {
                        cell.classList.toggle("col-hidden");
                    });
                });
            }

            dateToggleCheckboxes.forEach(checkbox => {
                checkbox.addEventListener("change", (event) => {
                    const colClass = event.target.dataset.dateCol;
                    const isChecked = event.target.checked;
                    document.querySelectorAll(`.comparison-table .${colClass}`).forEach(cell => {
                        if (isChecked) {
                            cell.classList.remove("col-hidden");
                        } else {
                            cell.classList.add("col-hidden");
                        }
                    });
                });
                const colClass = checkbox.dataset.dateCol;
                if (!checkbox.checked) {
                     document.querySelectorAll(`.comparison-table .${colClass}`).forEach(cell => cell.classList.add("col-hidden"));
                }
            });

            if (filterAbnormalItemsCb) {
                filterAbnormalItemsCb.addEventListener("change", applyFilters);
            }
        });
    </script>
</body>
</html>
